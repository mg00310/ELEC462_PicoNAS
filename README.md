# ELEC462_Pico-NAS
시스템프로그래밍 Team3

## 협업 가이드



### 1. 빌드 및 실행

-   **전체 빌드**: `make` 또는 `make all` (서버와 클라이언트 동시 빌드)
-   **서버 실행**: `./server`
-   **클라이언트 실행**: `./client <Server IP>`
-   **정리**: `make clean`

### 2. 프로젝트 구조

-   `Makefile`: 프로젝트 빌드 스크립트입니다.
-   `users.conf`: 서버가 사용자 인증 및 'Jail' 디렉터리 설정을 위해 사용하는 파일입니다. 형식: `사용자명:비밀번호:루트경로`

**공통**
-   `common.h`: **매우 중요.** 서버와 클라이언트가 공유하는 헤더 파일입니다. 통신 프로토콜 명령어(e.g., `AUTH`, `LS`), 응답 코드, 핵심 데이터 구조체(`FileInfo`)가 정의되어 있습니다. **이 파일을 수정할 경우, 서버와 클라이언트 모두에 영향을 미칩니다.**

**서버**
-   `server.c`: 메인 서버 로직입니다. 클라이언트의 연결을 `accept()`하고, 각 클라이언트를 별도의 스레드(`pthread`)로 처리합니다. 인증, 파일 목록 전송, 디렉터리 변경, 파일 다운로드 요청을 처리하며, `users.conf`에 명시된 'Jail' 보안 모델을 강제합니다.

**클라이언트**
-   `client.h`: 클라이언트의 모든 전역 변수와 함수 프로토타입을 선언하는 헤더 파일입니다.
-   `client_main.c`: 클라이언트의 시작점(`main` 함수)입니다. 서버 연결, 최초 인증, `ncurses` TUI 초기화 및 메인 루프를 담당합니다.
-   `client_net.c`: 클라이언트의 모든 네트워크 로직을 담당합니다. 서버에 명령을 보내고 응답을 해석하며, 특히 파일 다운로드는 각 파일마다 별도의 스레드를 생성하여 처리합니다.
-   `client_ui.c`: `ncurses` 기반의 모든 TUI 렌더링 및 사용자 키 입력 처리를 담당합니다.
-   `client_utils.c`: 정렬(`qsort`), 경로 파싱, 문자열 처리 등 클라이언트 전반에서 사용되는 유틸리티 함수들을 포함합니다.

### 3. 핵심 동작 원리

#### 3.1. 통신 프로토콜 (`common.h` 참조)

-   모든 통신은 TCP 소켓을 통해 이루어지며, 정의된 명령어(4바이트 문자열)를 기반으로 합니다.
-   **인증 (`AUTH`)**: 클라이언트가 `AUTH <user> <pass>`를 보내면, 서버는 `users.conf`를 확인 후 `OK` 또는 `ERR`로 응답합니다. 성공 시, 유저의 루트(Jail) 경로와 현재 경로를 함께 보내줍니다.
-   **목록 (`LS`)**: 클라이언트가 `LS`를 보내면, 서버는 `LS_S` + 파일 개수(`uint32_t`) + `FileInfo` 구조체 배열 + `LS_E` 순서로 응답합니다.
-   **이동 (`CD`)**: 클라이언트가 `CD <dir>`을 보내면, 서버는 Jail 시스템을 위반하지 않는지 검사 후 `OK` + 변경된 현재 경로를 보내줍니다.
-   **다운로드 (`GET`)**: **주의:** 파일 다운로드는 별도의 TCP 연결과 스레드에서 이루어집니다. 클라이언트는 새 소켓을 열어 서버에 다시 `AUTH` 인증을 한 후, `GET <path>` 명령으로 파일을 요청합니다.

#### 3.2. 클라이언트 TUI

-   `ncurses` 라이브러리를 사용하며, `client_main.c`의 메인 루프에서 `getch()`로 키 입력을 비동기적으로 받고 `draw_tui()`를 호출하여 화면을 다시 그립니다.
-   UI는 `Header`, `Path`, `List` 세 가지 `zone`으로 나뉘며, 포커스된 zone에 따라 키 입력 처리가 달라집니다.

#### 3.3. 멀티스레딩

-   **서버**: 각 클라이언트 연결을 별도의 스레드에서 처리하여 여러 클라이언트의 동시 접속을 지원합니다.
-   **클라이언트**: 각 파일 다운로드를 별도의 스레드에서 처리하여, 여러 파일을 동시에 다운로드하는 동안에도 UI가 멈추지 않습니다.

### 4. 코딩 컨벤션 및 주의사항

-   **전역 변수**: 클라이언트 코드는 `g_` 접두사를 사용하는 전역 변수(예: `g_file_list`, `g_sock_main`)에 크게 의존합니다. 기능 추가/수정 시 이 변수들의 상태 변화에 주의해야 합니다.
-   **모듈화**: 코드는 `net`, `ui`, `utils` 등으로 기능별 파일 분리가 잘 되어 있습니다. 새로운 함수 추가 시, 가장 적절한 파일에 배치해주세요.
-   **Jail 시스템**: 서버 측에서 `realpath()`를 통해 경로를 정규화하고, `root_path`와 비교하여 사용자가 자신의 홈 디렉터리를 벗어나는 것을 엄격히 금지합니다. 경로 관련 수정 시 이 보안 모델이 깨지지 않도록 주의해야 합니다.

#### 4.1. 커밋 메시지 컨벤션

프로젝트의 커밋 메시지는 'Conventional Commits' 스타일을 따릅니다. 이는 커밋 히스토리를 더 읽기 쉽고 명확하게 만듭니다.

**형식:** `<type>: <subject>`

**주요 타입:**
-   `feat`: 새로운 기능 추가
-   `fix`: 버그 수정
-   `docs`: 문서 수정 (README 등)
-   `style`: 코드 포맷팅, 세미콜론 누락 등 (코드 변경은 없지만 스타일만 수정)
-   `refactor`: 코드 리팩토링
-   `chore`: 빌드 업무, 패키지 매니저 설정 등 (프로덕션 코드 변경 없음)

---
## 추가 기능 아이디어

### 1. 파일 미리보기 (Enter 키)

-   **기능:** 파일 목록에서 특정 파일을 선택하고 Enter 키를 누르면, 파일 내용을 화면에 미리 보여줍니다.
-   **필요 라이브러리/시스템 콜:**
    -   `ncurses.h`: UI 처리 (키 입력, 새 창 생성).
    -   `sys/socket.h`: 클라이언트-서버 통신.
    -   `stdio.h`, `fcntl.h`, `unistd.h`: 파일 I/O (`open`, `read`, `close`).

### 2. 파일 다운로드 진행도 시각화

-   **기능:** 파일 다운로드 시, 해당 파일이 목록에 표시된 줄을 노란색 진행도 바로 채워 시각적으로 표현합니다.
-   **필요 라이브러리/시스템 콜:**
    -   `ncurses.h`: 색상 및 화면 속성 제어.
    -   `sys/stat.h`: `stat()`으로 파일 크기 확인.
    -   `pthread.h`: (선택) UI와 다운로드 로직 분리를 위한 멀티스레딩.

### 3. 터미널 배경화면

-   **기능:** 클라이언트 TUI에 시각적 효과를 위한 배경화면을 추가합니다.
-   **필요 라이브러리/시스템 콜:**
    -   `ncurses.h`: 배경 및 색상 제어.

### 4. 설정 및 다운로드 기록 저장

-   **기능:**
    1.  **클라이언트:** 다운로드 경로 등의 설정을 파일에 저장하고, 다운로드한 파일 기록을 관리합니다.
    2.  **서버:** 클라이언트별로 위 정보를 저장하고, 접속 시 해당 클라이언트에 정보를 전송합니다.
-   **필요 라이브러리/시스템 콜:**
    -   `stdio.h`, `string.h`: 파일 I/O 및 문자열 처리.

### 5. 편집 권한 및 파일 수정

-   **기능:** 파일 미리보기 상태에서 내용을 편집하고 저장할 수 있는 기능을 추가하되, 서버가 허용한 사용자만 가능하도록 합니다.
-   **필요 라이브러리/시스템 콜:**
    -   `ncurses.h`: 사용자 텍스트 입력 처리.
    -   `unistd.h`, `fcntl.h`: `open()`, `write()` 등 파일 제어.

### 6. 폴더 다운로드 및 경로 설정

-   **기능:**
    1.  폴더를 선택하면 폴더 전체를 하나의 파일로 다운로드합니다.
    2.  클라이언트에서 다운로드받을 위치를 지정할 수 있습니다.
-   **필요 라이브러리/시스템 콜:**
    -   `unistd.h`: `fork()`, `exec()` for running `tar`.
    -   `sys/stat.h`: `mkdir()` for creating download directory.
    -   (선택) `libtar`: `tar` 명령 실행 대신 라이브러리를 사용하여 `tar` 아카이브를 다룰 수 있습니다.

### 7. 파일별 비밀번호 설정

-   **기능:** 특정 파일에 비밀번호를 설정하여, 접근 시 비밀번호를 입력해야만 내용을 보거나 다운로드할 수 있도록 합니다.
-   **필요 라이브러리/시스템 콜:**
    -   `openssl/evp.h` 또는 `sodium.h`: 안전한 비밀번호 해싱.
    -   `stdio.h`: 파일별 접근 설정 파일 I/O.

### 8. 폴더 용량 계산 및 정렬 기능

-   **기능:** 파일 목록에 폴더의 전체 용량을 계산하여 표시하고, 이름, 크기, 날짜 등 다양한 기준으로 목록을 정렬하는 기능을 추가합니다.
-   **필요 라이브러리/시스템 콜:**
    -   `sys/stat.h`: `stat()`으로 파일 크기 획득.
    -   `ftw.h`: `nftw()`로 디렉터리 트리 재귀 탐색.
    -   `stdlib.h`: `qsort()`로 클라이언트에서 목록 정렬.

## 개발 참고 자료

- **아이콘 및 특수문자**: [https://symbl.cc/](https://symbl.cc/)
